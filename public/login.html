    <!DOCTYPE html>
    <html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Central do Assinante</title>
        <link rel="icon" href="https://feitosa-github-io.vercel.app/assets/ico.png" type="image/png">
        <style>
            /* Reset básico */
            body {
                font-family: "Aller", Helvetica, sans-serif;
                padding: 0;
                box-sizing: border-box;
                height: auto;
                margin: 0;
            }
        
            /* Navbar superior */
            .top-navbar {
                background-image: linear-gradient(to right, #246ECC, #1515A3);
                font-size: 10px;
                justify-content: right;
                height: 30px;
                margin: 0;
                color: white;
                display: flex; /* Para centralizar o conteúdo */
                display: none; /* Oculta a top-navbar por padrão */
            }
            .top-navbar.show {
                display: flex; /* Exibe a top-navbar quando a classe show é adicionada */
            }
            .top-navbar button {
                border: none;
                border-radius: 5px;
                margin-right: 20px;
                padding: 10px 15px; 
                width: 80px;
                color: white;
                background-color: #10107A;
                transition: transform 0.3s ease, background-color 0.3s ease;
            }
        
            .top-navbar button:hover {
                background-color:#0056b3;
                transform: scale(1.1);
            }
        
            /* Container principal */
            .container-atm {
                display: flex; /* Para organizar as divs lado a lado */
                flex-wrap: wrap;
                justify-content: center;
                align-items: center; /* Alinha as divs verticalmente ao centro */
                padding: 20px;
                gap: 25px;
                margin-top: 20px;
                max-width: 100%;
                height: auto;
                
            }
                            
            .auto-atendimento {
                display: none; /* Oculta a div auto-atendimento inicialmente */
                color: #10107A;
                flex-wrap: wrap;
                justify-content: flex-start;
                max-width: 60%;
                width: 650px;
                gap: 20px;
                border-radius: 8px;
                text-align: center;
            }
        
            .auto-atendimento h1 {
                font-size: 30px;    
                text-align: center;
                display: flex;
                justify-content: center;
            }
        
            .auto-atendimento img {
                max-width: 150px;
                max-width: 100px;
                height: auto;
                margin: 5px;
                background-color: #10107A;
                border-radius: 8px;
                padding: 25px 25px;
                cursor: pointer;
                transition: transform 0.3s ease;
            }
            .auto-atendimento img:hover {
                transform: scale(1.1);
            }
        
            .auto-atendimento button {
                background: none;
                border: none;
                padding: 0;
                cursor: pointer;
                margin: 5px;
                transition: transform 0.3s ease, background-color 0.3s ease;
            }
        
            .auto-atendimento button img {
                display: block;
                width: 150px; /* Altere conforme necessário */
                height: auto; /* Mantém a proporção da imagem */
                transition: transform 0.3s ease;
                margin: 0 auto; /* Centraliza as imagens dentro dos botões */
                transition: transform 0.3s ease, background-color 0.3s ease;
            }
        
            .auto-atendimento button:hover img {
                transform: scale(1.1);
            }
        
            #formContainer, #ossformContainer {
    position: relative;
    color: #fff;
    background-color: #10107A;
    border-radius: 8px;
    text-align: center;
    padding: 50px;
    max-width: 40%;
    width: 250px;
}

#formContainer img, #ossformContainer img {
    width: 200px;
}

#formContainer h3, #ossformContainer h3 {
    font-size: x-small;
}

#formContainer h1, #ossformContainer h1 {
    font-size: 25px;
}

.inputUser {
    background: none;
    border: none;
    border-bottom: 1px solid white;
    outline: none;
    color: white;
    font-size: 15px;
    width: 100%;
    letter-spacing: 2px;
}

.inputBox {
    position: relative;
}

.labelinput {
    position: absolute;
    font-size: 12px;
    top: 0px;
    left: 0px;
    pointer-events: none;
    transition: .5s;
}

.logoutbutton button {
    transition: transform 0.3s ease, background-color 0.3s ease;
}

.retorno-site button {
    background: white;
    width: 100px;
    border: none;
    padding: 10px;
    color: white;
    font-size: 12px;
    cursor: pointer;
    border-radius: 5px;
    text-decoration: none;
    transition: transform 0.3s ease, background-color 0.3s ease;  
}

.inputUser:focus ~ .labelinput,
.inputUser:valid ~ .labelinput {
    top: -20px;
    font-size: 12px;
    color: dodgerblue;
}

.ul {
    list-style-type: none; 
}

.formContainer button, #ossFormContainer button {
    background-color: #0056b3;
    width: 100%;
    border: none;
    padding: 10px;
    color: white;
    font-size: 12px;
    cursor: pointer;
    border-radius: 5px;
    transition: transform 0.3s ease, background-color 0.3s ease;
}

.formContainer button:hover, #ossFormContainer button:hover {
    background-color: #0056b3;
    transform: scale(1.1);
}   

#ossFormContainer {
    padding: 20px;
    max-width: 300px; /* Ajuste o tamanho conforme necessário */
}

#ossFormContainer label {
    display: block;
    font-size: 12px;
    color: white;
    margin-bottom: 8px;
}

#ossFormContainer select,
#ossFormContainer textarea {
    background: none;
    border: 1px solid #10107A;
    border-radius: 4px;
    outline: none;
    color: white;
    font-size: 15px;
    width: calc(100% - 20px);
    margin-bottom: 20px;
    padding: 10px;
}

.placeholder {
    color: white;
}

#ossFormContainer select {
    height: 40px;
}

#ossFormContainer textarea {
    height: 100px;
    resize: vertical;
}

        
            /* Estilos do Modal */
            .modal {
                display: none; /* Oculta o modal inicialmente */
                position: fixed;
                z-index: 1000;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 600px;
                width: 100%;
                overflow: auto;
                justify-content: center;
                align-items: center;
                height: 80%;
            }
            
            .modal-content {
                background-color: #10107A;
                color: #fff;
                margin: auto;
                font-size: 30px;
                padding: 20px;
                border: none;
                border-radius: 10px;
                width: 80%;
                max-width: 600px;
            }

            .close h3 {
                background-color: #ffffff;
                border-radius: 5px;
                color: #10107A;
                width: 70px;
                padding: 8px;
                text-align: right;
                margin: 0;
            }

            .close {
                
                font-size: 13px;
                font-weight: bold;
                transition: transform 0.3s ease;
            }

            .close:hover,
            .close:focus {
                color: #ffffff;
                transform: scale(1.1);
                text-decoration: none;
                cursor: pointer;
            }

            .textoModal {
                font-size: 12px;
                line-height: 1.5;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 5px;
                list-style-type: none;
            }


.textoProfile {
    width: 100%;
    text-align: center;
}

.textoProfile h1 {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
}

.textoProfile p span {
    font-weight: bold;
    color: #fff;
}

.textoProfile p::before {
    color: #fff;
    font-weight: bold;
}

            .textoModal span {
                font-size: 18px;
                display: inline; /* Garante que o span não quebre a linha */
                background-color: #0056b3;
                width: auto; /* Ajusta a largura do span para o conteúdo */
                border-radius: 5px;
            }

            .textoModal h4 {
                font-size: 14px;
                margin: 0; /* Remove a margem padrão do h4 */
                padding: 0; /* Remove o preenchimento padrão do h4 */
            }

            .textoModal a {
                display: inline; /* Garante que o link não quebre a linha */
            }

            li {
                border: none; /* Remove a borda dos itens da lista */
                border-radius: 10px;
                padding: 10px;
                margin-bottom: 10px;
            }

            ul {
                list-style-type: none; /* Remove os pontos dos itens da lista */
                padding: 0; /* Remove o padding padrão do <ul> */
                margin: 0; /* Remove a margem padrão do <ul> */
            }

            /* Estilos gerais para os itens de boletos */
            .textoModalBoletos {
                padding: 10px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                list-style-type: none;
                font-size: 15px;
                text-align: justify;
            }

            .textoModalBoletos h2 {
                
                font-size: 16px;
            }

            /* Estilo para boletos vencidos */
            .textoModalBoletos.vencido {
                background-color: #fe071c; /* Vermelho claro para vencidos */
                color: #721c24; /* Texto escuro para contraste */
            }

            /* Estilo para boletos pagos */
            .textoModalBoletos.pago {
                background-color: #e2e3e5; /* Cinza claro para pagos */
                color: #6c757d; /* Texto escuro para contraste */
            }

            /* Estilo para boletos em outros status */
            .textoModalBoletos {
                background-color: #d4edda; /* Verde claro para outros status */
                color: #155724; /* Texto escuro para contraste */
            }
            .hr {
                border: 1px solid #ddd; /* Exemplo de estilo */
                margin: 10px 0; /* Espaçamento */
            }

             /* Estilos gerais para os itens de Outros */
             .textoModalOutros {
                padding: 10px;
                margin-bottom: 10px;
                border: 2px solid;                
                border-radius: 5px;
                list-style-type: none;
                font-size: 17px;
                text-align: justify;
                background-color: #10107A;
                color: white;
            }

            .textoModalOutros h2 {
                font-size: 20px;
            }

            #ossForm {
                position: relative;
                color: #fff;
                background-color: #10107A;
                border-radius: 5px;
                text-align: center;
                padding: 30px;
                max-width: 100%;
                margin: auto;
            }

            #ossForm label {
                display: block;
                font-size: 12px;
                color: white;
                margin-bottom: 8px;
            }

            #ossForm select,
            #ossForm textarea {
                background: none;
                border-radius: 10px;
                outline: none;
                color: white;
                background-color: #0056b3;
                font-size: 15px;
                width: calc(100% - 20px);
                margin-bottom: 20px;
                padding: 10px;
            }

            #ossForm select {
                height: 50px;
                
            }

            #ossForm textarea {
                height: 100px;
                resize: vertical;
            }

            #ossForm button {
                background-color: #0056b3;
                width: 100%;
                border: none;
                padding: 10px;
                color: white;
                font-size: 12px;
                cursor: pointer;
                border-radius: 5px;
                transition: transform 0.3s ease, background-color 0.3s ease;
            }

            #ossForm button:hover {
                background-color: #0056b3;
                transform: scale(1.1);
            }

            @media (max-width: 768px) {
            /* Ajustes para telas menores */
            #ossformContainer {
                max-width: 50%; /* Reduz a largura máxima */
                width: auto; /* Ajusta a largura para ocupar o máximo permitido */
                padding: 15px; /* Reduz o padding para economizar espaço */
                border-radius: 20px;
                font-size: 20px;
            }

            #formContainer img {
                max-width: 50%; /* Reduz a largura máxima */
                width: auto; /* Ajusta a largura para ocupar o máximo permitido */
                padding: 15px; /* Reduz o padding para economizar espaço */
                border-radius: 20px;
                font-size: 20px;
            }

            #formContainer {
                max-width: 300px;
                width: 100%; /* Ajusta a largura para ocupar o máximo permitido */
                padding: 20px; /* Reduz o padding para economizar espaço */
                border-radius: 20px;
                font-size: 15px;
                height: auto;
            }

            .auto-atendimento {
                max-width: 100%; /* Reduz a largura máxima */
                width: 100%; /* Ajusta a largura para ocupar o máximo permitido */
                /* Reduz o padding para economizar espaço */
            }

            .textoProfile {
                max-width: 300px;
                width: 100%;
                height: auto;
                text-align: center;
                font-size: 15px;
                margin-top: -50px;
            }
        }

        </style> 
    </head>
    <body>
        <div class="top-navbar" id="top-navbar">
        </div>

        <div class="container-atm" id="container-atm">

            <div class="formContainer" id="formContainer">
                <img src="/assets/logo_vertical_feitosa_white_.png" alt="Logotipo">                
                <br>
                <form id="cpfForm">
                    <br>
                    <h1>Central do Assinante</h1>
                    <br>
                    <div class="inputBox">
                        <input type="text" id="cpf" name="cpf" class="inputUser" required>
                        <label for="cpf" class="labelinput">Para entrar, digite o seu CPF ou CNPJ:</label>
                    </div>
                    <br>
                    <br>
                    <!--<input type="text" id="pass" name="pass" placeholder="******" required>-->
                    <button type="submit">Entrar na central</button>
                    <br><br>
                    <a href="/index.html" class="retorno-site">
                        <button type="button">Retornar ao site</button>
                    </a>
                   
                </form>
                <br>
                <br>
                <div id="result">
                    <!-- O resultado da busca será exibido aqui -->
                </div>
            </div>

            <div class="auto-atendimento" id="auto-atendimento">          

                <div id="bemVindo">                
                    <h1>Serviços disponíveis para você.</h1>
                    <br>
                    <button data-page="Contrato">
                        <img src="/assets/a_contrato_.png" alt="Contrato">
                    </button>
                    
                    <button data-page="Boleto">
                        <img src="/assets/a_boleto_.png" alt="Boleto">
                    </button>

                    <button data-page="desbloqueio">
                        <img src="/assets/a_desbloqueio_.png" alt="desbloqueio">
                    </button>

                    <button data-page="Oss">
                        <img src="/assets/a_suporte_.png" alt="Oss">
                    </button>

                    <button data-page="criarOss">
                        <img src="/assets/a_cadastro_.png" alt="criarOss">
                    </button>

                    <button data-page="reiniciar">
                        <img src="/assets/a_desconexao_.png" alt="reiniciar">
                    </button>

                    <!--<a href="https://wa.me/5583999888759">
                    <button data-page="Outros">
                        <img src="/assets/a_outros_.png" alt="Outros">
                    </button>
                    </a>-->
                </div>
            </div>
            
            <!-- Modal -->
            <div id="myModal" class="modal">
                <div class="modal-content">
                    <span class="close"><h3>Fechar &times;</h3></span>
                    <br>
                    <div id="boletoContent">
                        <!-- O conteúdo do boleto será exibido aqui -->                      
                    </div> 
            
                    <div id="contratoContent">
                        <!-- O conteúdo do contrato será exibido aqui -->
                    </div>
            
                    <div id="ossContent">
                        <!-- O conteúdo de OSS será exibido aqui -->
                    </div>
            
                    <div id="criarOssContent">
                        <!-- O conteúdo de criar OSS será exibido aqui -->
                    </div>
                    
                    <div id="desbloqueioContent">
                        <!-- O conteúdo de desbloqueio será exibido aqui -->
                    </div>

                    <div id="reiniciarContent">
                        <!-- O conteúdo de desbloqueio será exibido aqui -->
                    </div>
                </div>
            </div>
        <div id="ossFormContainer" style="display: none;">
            <form id="ossForm">

                <div class="">
                    <label for="assunto">Primeiro, selecione um assunto:</label>
                    <select id="assunto" name="assunto" required>
                        <option value="8">Suporte técnico</option>
                        <option value="6">Financeiro</option>
                    </select>
                </div>
        
                <div>
                    <label for="mensagem">Como podemos te ajudar?</label>
                    <textarea id="mensagem" name="mensagem" placeholder="Descreva como podemos te ajudar" required></textarea>
                </div>
        
                <!-- Campos ocultos -->
                <input type="hidden" id="id_filial" name="id_filial" class="inputUser" value="1" />
                <input type="hidden" id="origem_endereco" name="origem_endereco" class="inputUser" value="M" />
                <input type="hidden" id="status" name="status" class="inputUser" value="A" />
                <input type="hidden" id="prioridade" name="prioridade" class="inputUser" value="1" />
                <input type="hidden" id="setor" name="setor" class="inputUser" value="1" />
                <input type="hidden" id="tipo" name="tipo" class="inputUser" value="C" />
        
                <button type="submit">Abrir novo chamado</button>
            </form>
        </div>
        <script>
            // Fecha o modal quando o usuário clica no X
                    const span = document.querySelector('.close');

                    const modal = document.getElementById('myModal'); // Certifique-se de que o ID do modal está correto
                    if (span && modal) {
                    span.addEventListener('click', () => {
                    modal.style.display = 'none';
                    limparModal(); // Limpa o conteúdo ao fechar o modal
                    });
                    }

                    // Fecha o modal quando o usuário clica fora dele
                    window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                    modal.style.display = 'none';
                    limparModal(); // Limpa o conteúdo ao fechar o modal
                    }
                    });

                    document.addEventListener('DOMContentLoaded', () => {                
    const buttons = document.querySelectorAll('.auto-atendimento button');
    const formContainer = document.getElementById('formContainer');
    const autoAtendimento = document.getElementById('auto-atendimento');
    const modal = document.getElementById('myModal');
    const topNavbar = document.getElementById('top-navbar');
    const cpfInput = document.getElementById('cpf');
    const span = document.querySelector('.close'); 
    
    // Função para fazer logout
    function logout() {
        localStorage.removeItem('clienteId');
        window.location.href = '/index.html'; // Redireciona para a tela de login
    }
    
    // Adiciona o listener ao botão de logout
    const logoutButton = document.querySelector('.logoutbutton');
    if (logoutButton) {
        logoutButton.addEventListener('click', logout);
    }
    
    // Exibe o formulário ao clicar no botão
    const openFormButton = document.getElementById('openForm');
    if (openFormButton) {
        openFormButton.addEventListener('click', () => {
            formContainer.style.display = 'block';
            openFormButton.style.display = 'none';
        });
    }
    
    // Função para buscar dados do cliente e validar login
    async function buscarClientes(cpf) {
    try {
        console.log("Fazendo requisição para o servidor proxy...");

        const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/cliente', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                qtype: "cnpj_cpf",
                query: cpf,
                oper: "=",
                page: "1",
                rp: "20",
                sortname: "cliente.id",
                sortorder: "desc",
            })
        });

        if (!response.ok) {
            throw new Error("Erro na requisição");
        }

        const data = await response.json();
        const cliente = data.registros ? data.registros[0] : null;
        const clienteId = cliente ? cliente.id : null;

        if (clienteId) {
            localStorage.setItem("clienteId", clienteId);

            // Mostra a div auto-atendimento
            autoAtendimento.style.display = 'flex';
            // Oculta o formulário após validação
            cpfForm.style.display = 'none';
            // Exibe a top-navbar após login
            topNavbar.classList.add('show');
            exibirResultado(cliente);
        } else {
            exibirResultado(null);
        }
    } catch (error) {
        console.error("Erro ao buscar clientes:", error.message);
        exibirErro("Erro ao buscar cliente.");
    }
}

// Função para exibir o resultado da busca
function exibirResultado(cliente) {
    const resultDiv = document.getElementById("result");

    if (cliente) {
        resultDiv.innerHTML = `<div class="textoProfile">
            <h1>Olá,<br>${cliente.razao}!</h1>
            <p><span>Meu endereço de instalação:</span> ${cliente.endereco}</p>
            <p><span>Meu contato:</span> ${cliente.telefone_celular}</p>
        </div>
        <div class="logoutbutton">
            <button id="logoutButton">Sair</button>
        </div>`;

        // Adiciona o manipulador de evento ao botão de logout
        document.getElementById("logoutButton").addEventListener("click", () => {
            // Remove o clienteId do localStorage
            localStorage.removeItem("clienteId");
            
            // Redireciona para a tela de login
            window.location.href = "login.html";
        });
    } else {
        resultDiv.innerHTML = "<p>Cliente não encontrado.</p>";
        autoAtendimento.style.display = 'none';
    }
}
    // Função para exibir mensagens de erro
    function exibirErro(mensagem) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = `<p style="color: red;">${mensagem}</p>`;
        autoAtendimento.style.display = 'none';
    }
    
    // Adiciona o listener ao formulário
    const cpfForm = document.getElementById("cpfForm");
    if (cpfForm) {
        cpfForm.addEventListener("submit", function(event) {
            event.preventDefault();
            const cpf = document.getElementById("cpf").value;
            buscarClientes(cpf);
        });
    }
    
   // Adiciona o listener aos botões da auto-atendimento
buttons.forEach(button => {
    button.addEventListener('click', async () => {
        const page = button.getAttribute('data-page');
        if (page) {
            modal.style.display = "block";
            if (page === 'Boleto') {
                await buscarBoletos();
            } else if (page === 'Contrato') {
                await buscarContratos();
            } else if (page === 'Oss') {
                await buscarOss();
            } else if (page === 'criarOss') {
                await criarOss();
            } else if (page === 'desbloqueio') {
                await desbloqueio();
            } else if (page === 'reiniciar') {
                await reiniciarConexao();
            }
        }
    });
});

    
// Função para formatar a data no formato dia/mês/ano
function formatarData(data) {
const partes = data.split('-'); // Supondo que a data vem no formato yyyy-mm-dd
return `${partes[2]}/${partes[1]}/${partes[0]}`; // Formato dia/mês/ano
}

// Função para buscar boletos
async function buscarBoletos() {
try {
console.log("Fazendo requisição para o servidor proxy...");

const clienteId = localStorage.getItem('clienteId');

if (!clienteId) {
console.error('Cliente com o id não encontrado');
return;
}

const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/boletos', {
method: 'POST',
headers: {
    'Content-Type': 'application/json',
},
body: JSON.stringify({ clienteId })
});

if (!response.ok) {
throw new Error("Erro na requisição");
}

const data = await response.json();
console.log(data.registros);

const boletoContent = document.getElementById('boletoContent');
if (data.registros && data.registros.length > 0) {
// Filtrar boletos com status "A", "R", ou "P"
const boletosFiltrados = data.registros.filter(boleto => {
    return ["A", "R", "P"].includes(boleto.status);
});

// Ordenar boletos: não vencidos primeiro (ordenados pelo vencimento), depois vencidos
const hoje = new Date();
const boletosOrdenados = boletosFiltrados.sort((a, b) => {
    const vencimentoA = new Date(a.data_vencimento);
    const vencimentoB = new Date(b.data_vencimento);

    // Primeiro os não vencidos, ordenados por data de vencimento
    if (vencimentoA >= hoje && vencimentoB >= hoje) {
        return vencimentoA - vencimentoB;
    }
    // Em seguida os vencidos, ordenados por data de vencimento
    if (vencimentoA < hoje && vencimentoB < hoje) {
        return vencimentoA - vencimentoB;
    }
    // Coloca os não vencidos acima dos vencidos
    return vencimentoA >= hoje ? -1 : 1;
});

const resultadosLimitados = boletosOrdenados.slice(0, 12);

boletoContent.innerHTML = '<ul>' + resultadosLimitados.map(boleto => {
    const vencimento = new Date(boleto.data_vencimento);
    let classeVencido = ''; 
    let classePago = '';

    // Lógica para considerar pago ou vencido
    if (vencimento < hoje && boleto.status === "A") {
        classeVencido = 'vencido'; // Considera vencido se a data for anterior e status "A"
    } else if (boleto.status === "R") {
        classePago = 'pago'; // Adiciona classe 'pago' para boletos com status "R"
    }

    return `
        <li class="textoModalBoletos ${classeVencido} ${classePago}">
    <h4><center>
        <span>Fatura nº:</span> ${boleto.id}
        <span style="margin-left: 40px;">Venc.:</span> ${formatarData(boleto.data_vencimento)}
    
        <span style="margin-left: 40px;">Valor:</span> R$ ${boleto.valor}
        <p>
        <span>Status:</span> ${boleto.status === "A" ? "Aberto" : boleto.status === "R" ? "Pago" : "Vencido"}
        
        <span style="margin-left: 30px;">  Download:</span> 
        <a href="${boleto.gateway_link}.pdf" target="_blank">  Clique aqui</a>
    </p></center></h4>
</li>`;
}).join('') + '</ul>';
} else {
boletoContent.innerHTML = '<p>Nenhum boleto encontrado.</p>';
}

} catch (error) {
console.error("Erro ao buscar boletos:", error.message);
}
}


// Função para formatar o CPF
function formatCPF(cpf) {
    cpf = cpf.replace(/\D/g, ''); // Remove todos os caracteres não numéricos
    cpf = cpf.substring(0, 11); // Limita a 11 caracteres

    // Aplica a formatação padrão do CPF
    if (cpf.length > 9) {
        cpf = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
    } else if (cpf.length > 6) {
        cpf = cpf.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
    } else if (cpf.length > 3) {
        cpf = cpf.replace(/(\d{3})(\d{1,3})/, '$1.$2');
    }

    return cpf;
}

// Adiciona o evento de input para formatar o CPF
cpfInput.addEventListener('input', () => {
    cpfInput.value = formatCPF(cpfInput.value);
});

});
    
// Função para buscar contratos e armazenar contratoId
async function buscarContratos() {
    try {
        console.log("Fazendo requisição para o servidor proxy...");

        const clienteId = localStorage.getItem('clienteId');

        if (!clienteId) {
            console.error('Cliente ID não encontrado');
            return;
        }

        const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/contratos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                qtype: "id_cliente",
                query: clienteId,
                oper: "=",
                page: "1",
                rp: "20",
                sortname: "cliente_contrato.id",
                sortorder: "desc",
            })
        });

        if (!response.ok) {
            throw new Error("Erro na requisição: " + response.statusText);
        }

        const data = await response.json();
        console.log('Dados da resposta:', data);

        const contratoContent = document.getElementById('contratoContent');
        if (data.registros && data.registros.length > 0) {
            // Armazena o primeiro contratoId no localStorage
            const contratoId = data.registros[0].id;
            console.log('Contrato ID obtido:', contratoId);
            localStorage.setItem('contratoId', contratoId);

            contratoContent.innerHTML = '<ul>' + data.registros.map((contrato, index) => {
                const tipoContrato = contrato.tipo === "I" ? "Internet" : "Desconhecido";
                const statusConexao = contrato.status_internet === "A" ? "Ativo" : 
                                      contrato.status_internet === "CM" ? "Suspenso" : 
                                      "Desconhecido";
                const statusContrato = contrato.status === "A" ? "Ativo" :  
                                       contrato.status === "I" ? "Inativo/Cancelado" : 
                                       "Desconhecido";

                const hrTag = index < data.registros.length - 1 ? '<hr>' : '';

                return `
                    <li class="textoModalOutros">
                        <h4><center>
                                <p>
                                    <span>Contrato nº:</span> ${contrato.id} <span style="margin-left: 30px;">Status: ${statusContrato}</span>
                                </p>
                                <p>
                                <span>Status conexão: ${statusConexao}</span>
                                </p>
                                <p>
                                    Plano de internet: <h2>${contrato.contrato}</h2>
                                </p></center>
                            </h4>
                    </li>${hrTag}`;
            }).join('') + '</ul>';
        } else {
            contratoContent.innerHTML = '<p>Nenhum contrato encontrado.</p>';
        }

    } catch (error) {
        console.error("Erro ao buscar contratos:", error.message);
    }
}


// Função para buscar OSS
async function buscarOss() {
try {
console.log("Fazendo requisição para o servidor proxy...");

const clienteId = localStorage.getItem('clienteId');

if (!clienteId) {
console.error('Cliente com o id não encontrado');
return;
}

const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/oss', {
method: 'POST',
headers: {
    'Content-Type': 'application/json',
},
body: JSON.stringify({ clienteId })
});

if (!response.ok) {
throw new Error("Erro na requisição");
}

const data = await response.json();
console.log(data);

const ossContent = document.getElementById('ossContent');

if (data && data.length > 0) {
// Limita o número de registros a 5
const resultadosLimitados = data.slice(0, 5);

// Gera o HTML para os registros limitados
ossContent.innerHTML = '<ul>' + resultadosLimitados.map(oss => `<li class="textoModalOutros">
        <h4><center>
    <p>
        <span>Chamado nº:</span> ${oss.id}
        <span style="margin-left: 40px;">Protocolo:</span>
        <h2 style="display: inline;">${oss.protocolo}</h2>
    </p>
    Descrição:<p>${oss.mensagem}</p>
    
        Solução:
                <p>${oss.mensagem_resposta}</p>
        
</center></h4>
    </li>`).join('') + '</ul>';
} else {
ossContent.innerHTML = '<p>Nenhuma OSS encontrada.</p>';
}

} catch (error) {
console.error("Erro ao buscar OSS:", error.message);
}
}

// Função para Criar Oss
async function criarOss() {
try {
console.log("Exibindo o formulário de OSS...");

const clienteId = localStorage.getItem('clienteId');
if (!clienteId) {
console.error('Cliente com o id não encontrado');
return;
}

const criarOssContent = document.getElementById('criarOssContent');

const formHtml = `
<form id="ossForm">
    <div style="display: none;">
        <input type="hidden" id="tipo" name="tipo" value="C" />
        <input type="hidden" id="id_assunto" name="id_assunto" value="1" />
        <input type="hidden" id="id_cliente" name="id_cliente" value="${clienteId}" />
        <input type="hidden" id="id_filial" name="id_filial" value="1" />
        <input type="hidden" id="origem_endereco" name="origem_endereco" value="M" />
        <input type="hidden" id="prioridade" name="prioridade" value="1" />
        <input type="hidden" id="setor" name="setor" value="1" />
        <input type="hidden" id="status" name="status" value="A" />
    </div>

    <div>
        <label for="assunto">Sobre qual assunto deseja falar?</label>
        <select id="assunto" name="assunto" required>
            <option value="8">Suporte técnico</option>
            <option value="6">Financeiro</option>
        </select>
    </div>

    <div>
        <label for="mensagem">Como podemos te ajudar?</label>
        <textarea id="mensagem" name="mensagem" required></textarea>
    </div>

    <button type="submit">Abrir novo chamado</button>
</form>
`;

criarOssContent.innerHTML = formHtml;
document.getElementById('myModal').style.display = 'block';

document.getElementById('ossForm').addEventListener('submit', async function(event) {
event.preventDefault();

console.log("Fazendo requisição para o servidor proxy...");

const formData = new FormData(event.target);
const formObject = Object.fromEntries(formData.entries());

const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/criar-oss', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(formObject)
});

if (!response.ok) {
    const errorText = await response.text();
    console.error("Erro na requisição:", errorText);
    throw new Error("Erro na requisição");
}

const data = await response.json();
console.log("Resposta do servidor:", data);

let resultHtml = '';
if (data.success) {
    resultHtml = `<p>OSS criada com sucesso!</p>`;
} else {
    resultHtml = `<p>Erro ao criar OSS: ${data.message}</p>`;
}

criarOssContent.innerHTML = resultHtml;
});

} catch (error) {
console.error("Erro ao abrir OSS:", error.message);
}
}


// Função para limpar o conteúdo do modal
function limparModal() {
const boletoContent = document.getElementById('boletoContent');
const contratoContent = document.getElementById('contratoContent');
const ossContent = document.getElementById('ossContent');
const desbloqueioContent = document.getElementById('desbloqueioContent');
const criarOssContent = document.getElementById('criarOssContent');
const reiniciarContent= document.getElementById('reiniciarContent');

if (boletoContent) boletoContent.innerHTML = '';
if (contratoContent) contratoContent.innerHTML = '';
if (ossContent) ossContent.innerHTML = '';
if (desbloqueioContent) desbloqueioContent.innerHTML = ''; 
if (criarOssContent) criarOssContent.innerHTML = '';
if (reiniciarContent) reiniciarContent.innerHTML = ''; 
}

document.addEventListener('DOMContentLoaded', () => {
const cpfInput = document.getElementById('cpf');

// Função para formatar o CPF
function formatCPF(cpf) {
cpf = cpf.replace(/\D/g, ''); // Remove todos os caracteres não numéricos
cpf = cpf.substring(0, 11); // Limita a 11 caracteres

// Aplica a formatação padrão do CPF
if (cpf.length > 9) {
cpf = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
} else if (cpf.length > 6) {
cpf = cpf.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
} else if (cpf.length > 3) {
cpf = cpf.replace(/(\d{3})(\d{1,3})/, '$1.$2');
}

return cpf;
}

// Adiciona o evento de input para formatar o CPF
cpfInput.addEventListener('input', () => {
cpfInput.value = formatCPF(cpfInput.value);
});
});

// Função para reiniciar a conexão
async function reiniciarConexao() {
    const reiniciarContent = document.getElementById('reiniciarContent');

    try {
        // Obtém o clienteId do localStorage
        const clienteId = localStorage.getItem('clienteId');
        console.log('Cliente ID obtido do localStorage:', clienteId);

        if (!clienteId) {
            console.error('ID do cliente não encontrado no localStorage.');
            reiniciarContent.innerHTML = `
                <div class="textoModalOutros">
                    <h4><center>
                        <p>ID do cliente não encontrado.</p>
                        <p>Por favor, verifique se o ID está disponível no localStorage.</p>
                    </center></h4>
                </div>
            `;
            return;
        }

        // Faz a requisição para buscar os usuários
        const usuariosResponse = await fetch('https://feitosa-github-io.vercel.app/api/proxy/usuarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ clienteId })
        });

        console.log('Resposta da API para buscar usuários:', usuariosResponse);

        if (!usuariosResponse.ok) {
            const errorData = await usuariosResponse.text(); 
            console.error('Erro ao buscar usuários:', errorData);
            reiniciarContent.innerHTML = 'Erro ao buscar usuários: ' + (errorData || usuariosResponse.statusText);
            return;
        }

        const usuariosResult = await usuariosResponse.json();
        console.log('Usuários obtidos:', usuariosResult);

        // Acessa a lista de registros de usuários
        const usuarios = usuariosResult.registros;
        if (!usuarios || usuarios.length === 0) {
            console.error('Nenhum usuário encontrado para o cliente.');
            reiniciarContent.innerHTML = `
                <div class="textoModalOutros">
                    <h4><center>
                        <p>Nenhum usuário encontrado para o cliente.</p>
                        <p>Por favor, consulte nosso atendimento.</p>
                    </center></h4>
                </div>
            `;
            return;
        }

        // Obtém o ID do primeiro usuário
        const loginId = usuarios[0].id;
        console.log('ID do login obtido:', loginId);

        // Armazena o loginId no localStorage
        localStorage.setItem('loginId', loginId);
        console.log('loginId armazenado no localStorage:', localStorage.getItem('loginId'));

        // Envia a requisição para reiniciar a conexão usando o loginId
        const requestBody = JSON.stringify({ id: loginId });
        console.log('Enviando requisição para reinício de conexão com corpo:', requestBody);

        const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/reiniciar-conexao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: requestBody
        });

        console.log('Resposta da API para reiniciar conexão:', response);

        if (!response.ok) {
            const errorData = await response.text(); 
            console.error('Erro ao reiniciar a conexão:', errorData);
            reiniciarContent.innerHTML = 'Erro ao reiniciar a conexão: ' + (errorData || response.statusText);
            return;
        }

        const result = await response.json();
        console.log('Resultado do reinício de conexão:', result);

        if (result.type === 'error') {
            reiniciarContent.innerHTML = `
                <div class="textoModalOutros">
                    <h4><center>
                        <p>Não é possível reiniciar a conexão no momento.</p>
                        <p>Consulte nosso atendimento.</p>
                    </center></h4>
                </div>
            `;
        } else {
            reiniciarContent.innerHTML = `
                <div class="textoModalOutros">
                    <h4><center>
                        <p>Conexão reiniciada com sucesso!</p>
                        <p><span>Aguarde 2(dois) minutos e verifique sua conexão.</span></p>
                        <p>Se o problema persistir, abra um novo chamado.</p>
                    </center></h4>
                </div>
            `;
        }

    } catch (error) {
        console.error("Erro ao reiniciar a conexão. Consulte nosso atendimento.", error.message);
        reiniciarContent.innerHTML = `
            <div class="textoModalOutros">
                <h4><center>
                    <p>Erro ao reiniciar a conexão.</p>
                    <p>Consulte nosso atendimento.</p>
                </center></h4>
            </div>
        `;
    }
}

// Função para desbloqueio de confiança
async function desbloqueio() {
    const desbloqueioContent = document.getElementById('desbloqueioContent');

    try {
        const contratoId = localStorage.getItem('contratoId');
        console.log('Contrato ID obtido do localStorage:', contratoId);

        if (!contratoId) {
            console.error('ID do contrato não encontrado no localStorage.');
            desbloqueioContent.innerHTML = `
                                    <div class="textoModalOutros">
                                        <h4><center>
                                            <p>Consulte o status do seu plano.</p>
                                            <p>Desbloqueio disponível apenas para serviço com status suspenso.</p>
                                        </center></h4>
                                    </div>
                                `;
            return;
        }

        const requestBody = JSON.stringify({ id: contratoId });
        console.log('Enviando requisição para desbloqueio de confiança com corpo:', requestBody);

        const response = await fetch('https://feitosa-github-io.vercel.app/api/proxy/desbloqueio-confianca', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: requestBody
        });

        console.log('Resposta da API:', response);

        if (!response.ok) {
            const errorData = await response.text(); // Mudar para text() para melhor depuração
            console.error('Erro ao desbloquear confiança:', errorData);
            desbloqueioContent.innerHTML = 'Erro ao desbloquear confiança: ' + (errorData || response.statusText);
            return;
        }

        const result = await response.json();
        console.log('Resultado do desbloqueio de confiança:', result);

            if (result.type === 'error') {
        if (result.message.includes("Não é possível utilizar o botão 'Desbloqueio de confiança'")) {
            desbloqueioContent.innerHTML = `
                <div class="textoModalOutros">
                    <h4><center>
                        <p>Desbloqueio de confiança não está disponível no momento.</p>
                        <p>Consulte nosso atendimento.</p>
                    </center></h4>
                </div>
            `;
        } else {
            desbloqueioContent.innerHTML = `
                <div class="textoModalOutros">
                    <h4><center>
                        <p>Desbloqueio de confiança não está disponível no momento.</p>
                        <p>Consulte nosso atendimento.</p>
                    </center></h4>
                </div>
            `;
        }
    } else {
        desbloqueioContent.innerHTML = `
            <div class="textoModalOutros">
                <h4><center>
                    <p>Desbloqueio realizado com sucesso!</p>
                    <p><span>Lembre-se de efetuar o pagamento para continuar navegando!</span></p>
                </center></h4>
            </div>
        `;
    }

    } catch (error) {
        console.error("Desbloqueio de confiança não está disponível no momento. Consulte nosso atendimento.", error.message);
        desbloqueioContent.innerHTML = `
            <div class="textoModalOutros">
                <h4><center>
                    <p>Desbloqueio de confiança não está disponível no momento.</p>
                    <p>Consulte nosso atendimento.</p>
                </center></h4>
            </div>
        `;
    }

    }

        </script>
    </body>
    </html>
